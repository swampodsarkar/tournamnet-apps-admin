<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root {
            --bs-body-bg: #1a1a2e;
            --bs-body-color: #e0e0e0;
            --bs-secondary-bg: #162447;
            --bs-tertiary-bg: #1f4068;
            --bs-primary: #e43f5a;
            --bs-border-color: #1b262c;
            --bs-gold: #ffd700;
            --bs-gold-glow: 0 0 10px rgba(255, 215, 0, 0.7);
        }

        body {
            display: flex;
            min-height: 100vh;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
        }

        /* Golden Glow Effects */
        .gold-glow {
            box-shadow: var(--bs-gold-glow);
            border: 1px solid rgba(255, 215, 0, 0.3) !important;
        }
        
        .gold-text {
            color: var(--bs-gold);
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }
        
        .gold-border {
            border-color: var(--bs-gold) !important;
        }

        #admin-login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1060;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(to bottom, #1a1a2e, #0f3460);
            flex-shrink: 0;
            border-right: 1px solid rgba(255, 215, 0, 0.2);
        }

        .sidebar .nav-link {
            color: var(--bs-body-color);
            border-radius: 0.375rem;
            margin: 2px 0;
            transition: all 0.3s ease;
        }

        .sidebar .nav-link.active,
        .sidebar .nav-link:hover {
            background: linear-gradient(to right, #ffd700, #daa520);
            color: #000 !important;
            box-shadow: var(--bs-gold-glow);
        }

        .main-content {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
            background: rgba(26, 26, 46, 0.8);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .stat-card {
            background: linear-gradient(135deg, #162447, #1f4068);
            border-left: 5px solid var(--bs-gold);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--bs-gold-glow);
        }
        
        .form-control, .form-select, .modal-content {
            background-color: var(--bs-secondary-bg);
            border-color: var(--bs-border-color);
            color: var(--bs-body-color);
        }
        
        .form-control:focus, .form-select:focus {
            background-color: var(--bs-secondary-bg);
            border-color: var(--bs-gold);
            box-shadow: 0 0 0 0.25rem rgba(255, 215, 0, 0.25);
            color: var(--bs-body-color);
        }
        
        .btn-primary { 
            background: linear-gradient(to bottom, #ffd700, #daa520);
            border-color: #ffd700;
            color: #000;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(to bottom, #daa520, #b8860b);
            border-color: #daa520;
            box-shadow: var(--bs-gold-glow);
            color: #000;
        }
        
        /* Post Management Styles */
        .post-card {
            background-color: var(--bs-secondary-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 0.5rem;
            transition: transform 0.2s;
        }
        
        .post-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--bs-gold-glow);
        }
        
        .post-image {
            height: 200px;
            object-fit: cover;
            width: 100%;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        
        .post-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .post-status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        
        .post-author-img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        /* Tournament Tabs */
        .tournament-tabs .nav-link {
            color: var(--bs-body-color);
            border-radius: 0.375rem;
            margin-right: 0.5rem;
        }
        
        .tournament-tabs .nav-link.active {
            background: linear-gradient(to right, #ffd700, #daa520);
            color: #000 !important;
            box-shadow: var(--bs-gold-glow);
        }
        
        /* Player List */
        .player-list-item {
            background-color: var(--bs-tertiary-bg);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .player-list-item:hover {
            background-color: #2a4075;
            box-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
        }
        
        /* Table Styling */
        .table {
            --bs-table-bg: transparent;
            --bs-table-color: var(--bs-body-color);
            --bs-table-border-color: var(--bs-border-color);
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(255, 215, 0, 0.1);
        }
        
        /* Modal Styling */
        .modal-content {
            background: linear-gradient(135deg, #162447, #1f4068);
            border: 1px solid var(--bs-gold);
            box-shadow: var(--bs-gold-glow);
        }
        
        .modal-header {
            border-bottom: 1px solid var(--bs-gold);
        }
        
        .modal-footer {
            border-top: 1px solid var(--bs-gold);
        }
        
        /* Toast Styling */
        .toast {
            background: linear-gradient(135deg, #162447, #1f4068);
            border: 1px solid var(--bs-gold);
            box-shadow: var(--bs-gold-glow);
        }
        
        /* Card Styling */
        .card {
            background: linear-gradient(135deg, #162447, #1f4068);
            border: 1px solid var(--bs-border-color);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: var(--bs-gold-glow);
            border-color: var(--bs-gold);
        }
        
        /* Custom checkbox and radio buttons */
        .form-check-input:checked {
            background-color: var(--bs-gold);
            border-color: var(--bs-gold);
        }
        
        /* Tournament slot styling */
        .slot-badge {
            background: linear-gradient(to right, #ffd700, #daa520);
            color: #000;
            font-weight: bold;
        }
    </style>
</head>
<body>
    
    <div id="admin-login-overlay">
        <div class="text-center p-4 rounded gold-glow" style="background: var(--bs-secondary-bg); width: 320px;">
            <h4 class="mb-3 gold-text">Admin Panel Access</h4>
            <form id="admin-login-form">
                <div class="form-floating mb-3">
                    <input type="password" class="form-control" id="admin-password" placeholder="Password">
                    <label for="admin-password">Password</label>
                </div>
                <button type="submit" class="btn btn-primary w-100">Enter</button>
            </form>
        </div>
    </div>

    <div class="d-flex w-100" id="admin-content" style="visibility: hidden;">
        <div class="sidebar d-flex flex-column p-3">
            <h4 class="text-center mb-4 gold-text">Admin Panel</h4>
            <ul class="nav nav-pills flex-column mb-auto" id="admin-nav">
                <li class="nav-item"><a href="#" class="nav-link active" data-page="dashboard"><i class="bi bi-grid-fill me-2"></i>Dashboard</a></li>
                <li class="nav-item"><a href="#" class="nav-link" data-page="players"><i class="bi bi-people-fill me-2"></i>Player Management</a></li>
                <li class="nav-item"><a href="#" class="nav-link" data-page="tournaments"><i class="bi bi-trophy-fill me-2"></i>Tournaments</a></li>
                <li class="nav-item"><a href="#" class="nav-link" data-page="transactions"><i class="bi bi-wallet2 me-2"></i>Transactions</a></li>
                <li class="nav-item"><a href="#" class="nav-link" data-page="posts"><i class="bi bi-file-post me-2"></i>Post Management</a></li>
                <li class="nav-item"><a href="#" class="nav-link" data-page="banners"><i class="bi bi-image me-2"></i>Banner Management</a></li>
                <li class="nav-item"><a href="#" class="nav-link" data-page="support"><i class="bi bi-headset me-2"></i>Support Chat</a></li>
            </ul>
        </div>

        <main class="main-content">
            <div id="dashboard" class="page active">
                <h3 class="gold-text">Dashboard</h3>
                <div class="row g-4 mt-2">
                    <div class="col-md-3">
                        <div class="p-3 stat-card rounded">
                            <h5>Total Players</h5>
                            <h2 id="stat-total-players" class="gold-text">0</h2>
                        </div>
                    </div>
                    <div class="col-md-3">
                         <div class="p-3 stat-card rounded">
                            <h5>Total Tournaments</h5>
                            <h2 id="stat-total-tournaments" class="gold-text">0</h2>
                        </div>
                    </div>
                    <div class="col-md-3">
                         <div class="p-3 stat-card rounded">
                            <h5>Pending Txns</h5>
                            <h2 id="stat-pending-txns" class="gold-text">0</h2>
                        </div>
                    </div>
                    <div class="col-md-3">
                         <div class="p-3 stat-card rounded">
                            <h5>Support Tickets</h5>
                            <h2 id="stat-support-tickets" class="gold-text">0</h2>
                        </div>
                    </div>
                </div>
                <h4 class="mt-5 gold-text">Recent Activity</h4>
                <div id="recent-activity" class="list-group mt-3">
                    <!-- Recent activity will be loaded here -->
                </div>
            </div>

            <div id="players" class="page">
                <h3 class="gold-text">Player Management</h3>
                <input type="text" id="player-search" class="form-control mb-3" placeholder="Search by Name or FF ID...">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr><th>Name</th><th>Email</th><th>FF ID</th><th>Role</th><th>Wallet</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="players-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="tournaments" class="page">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="gold-text">Tournament Management</h3>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#tournamentModal"><i class="bi bi-plus-lg"></i> Add Tournament</button>
                </div>
                
                <!-- Tournament Tabs -->
                <ul class="nav nav-pills tournament-tabs mb-4">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#all-tournaments">All Tournaments</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#my-tournaments">My Tournaments</a>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <!-- All Tournaments Tab -->
                    <div class="tab-pane fade show active" id="all-tournaments">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr><th>Name</th><th>Type</th><th>Date</th><th>Fee</th><th>Slots</th><th>Status</th><th>Players</th><th>Winner</th><th>Actions</th></tr>
                                </thead>
                                <tbody id="tournaments-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- My Tournaments Tab -->
                    <div class="tab-pane fade" id="my-tournaments">
                        <div class="mb-3">
                            <input type="text" id="my-tournament-search" class="form-control" placeholder="Search my tournaments...">
                        </div>
                        
                        <div id="my-tournaments-container">
                            <!-- My tournaments will be loaded here -->
                        </div>
                        
                        <div id="my-tournaments-loading" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading tournaments...</p>
                        </div>
                        
                        <div id="no-my-tournaments" class="text-center py-5 d-none">
                            <i class="bi bi-trophy display-4 text-muted"></i>
                            <p class="mt-2 text-muted">You haven't created any tournaments yet</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="transactions" class="page">
                <h3 class="gold-text">Transaction Management</h3>
                <h5 class="mt-4 gold-text">Pending Deposit Requests</h5>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr><th>User</th><th>Method</th><th>Amount</th><th>Phone</th><th>TrxID</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="deposits-table-body"></tbody>
                    </table>
                </div>
                <h5 class="mt-4 gold-text">Pending Withdraw Requests</h5>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr><th>User</th><th>Method</th><th>Amount</th><th>Account</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="withdraws-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="posts" class="page">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="gold-text">Post Management</h3>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#postModal"><i class="bi bi-plus-lg"></i> Create Post</button>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <input type="text" id="post-search" class="form-control" placeholder="Search posts...">
                    </div>
                    <div class="col-md-3">
                        <select id="post-status-filter" class="form-select">
                            <option value="all">All Status</option>
                            <option value="published">Published</option>
                            <option value="draft">Draft</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="post-author-filter" class="form-select">
                            <option value="all">All Authors</option>
                        </select>
                    </div>
                </div>
                
                <div id="posts-container" class="row g-4">
                    <!-- Posts will be loaded here -->
                </div>
                
                <div id="posts-loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading posts...</p>
                </div>
                
                <div id="no-posts" class="text-center py-5 d-none">
                    <i class="bi bi-file-text display-4 text-muted"></i>
                    <p class="mt-2 text-muted">No posts found</p>
                </div>
            </div>

            <div id="banners" class="page">
                 <h3 class="gold-text">Banner Management</h3>
                 <div class="row g-4">
                     <div class="col-md-6">
                         <div class="card gold-glow">
                             <div class="card-body">
                                 <h5 class="card-title gold-text">Main Tournament Banner</h5>
                                 <p class="card-text">This banner appears at the top of the home page.</p>
                                 <form id="main-banner-form">
                                     <input type="file" class="form-control mb-2" id="main-banner-upload" accept="image/*" required>
                                     <button type="submit" class="btn btn-primary">Upload</button>
                                 </form>
                                 <div id="main-banner-preview" class="mt-3"></div>
                             </div>
                         </div>
                     </div>
                     <div class="col-md-6">
                         <div class="card gold-glow">
                             <div class="card-body">
                                 <h5 class="card-title gold-text">Announcement Popup Banner</h5>
                                 <p class="card-text">This banner shows as a dismissable popup.</p>
                                 <form id="announcement-banner-form">
                                     <input type="file" class="form-control mb-2" id="announcement-banner-upload" accept="image/*" required>
                                     <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" role="switch" id="announcement-active-toggle" checked>
                                        <label class="form-check-label" for="announcement-active-toggle">Activate Popup</label>
                                     </div>
                                     <button type="submit" class="btn btn-primary">Upload & Set</button>
                                 </form>
                                 <div id="announcement-banner-preview" class="mt-3"></div>
                             </div>
                         </div>
                     </div>
                 </div>
            </div>

            <div id="support" class="page">
                <h3 class="gold-text">Support Chat Tickets</h3>
                <div class="row">
                    <div class="col-md-4">
                        <div id="support-tickets-list" class="list-group">
                            <!-- Support tickets will be loaded here -->
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div id="support-chat-view" class="d-none">
                            <h5 id="chat-user-name" class="gold-text"></h5>
                            <div id="admin-chat-messages" class="border rounded p-3 mb-3 gold-glow" style="height: 60vh; overflow-y: auto; display:flex; flex-direction: column-reverse;"></div>
                            <form id="admin-chat-form" class="d-flex gap-2">
                                <input type="text" id="admin-chat-input" class="form-control" placeholder="Reply to user..." required>
                                <button type="submit" class="btn btn-primary">Send</button>
                            </form>
                        </div>
                        <div id="support-chat-placeholder">
                            <p class="text-center text-muted mt-5">Select a ticket to view the chat.</p>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Tournament Modal -->
    <div class="modal fade" id="tournamentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title gold-text" id="tournament-modal-title">Add Tournament</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="tournament-form">
                        <input type="hidden" id="tournament-id">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Name</label>
                                <input type="text" id="t-name" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Type</label>
                                <select id="t-type" class="form-select" required>
                                    <option>Battle Royale</option>
                                    <option>Clash Squad</option>
                                    <option>Lone Wolf</option>
                                    <option>Squad</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Date</label>
                                <input type="datetime-local" id="t-date" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Prize Pool</label>
                                <input type="text" id="t-prize" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Entry Fee</label>
                                <input type="number" id="t-fee" class="form-control" value="0" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Total Slots</label>
                                <input type="number" id="t-slots" class="form-control" min="2" value="10" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Status</label>
                                <select id="t-status" class="form-select" required>
                                    <option>Open</option>
                                    <option>Full</option>
                                    <option>Closed</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Room ID (Optional)</label>
                                <input type="text" id="t-room-id" class="form-control">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Room Password (Optional)</label>
                                <input type="text" id="t-room-pass" class="form-control">
                            </div>
                            <div class="col-12 mb-3">
                                <label class="form-label">Rules</label>
                                <textarea id="t-rules" class="form-control" rows="3" required></textarea>
                            </div>
                            <div class="col-12 mb-3">
                                <label class="form-label">Poster Image</label>
                                <input type="file" id="t-poster" class="form-control" accept="image/*">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Tournament</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Winner Modal -->
    <div class="modal fade" id="winnerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title gold-text">Declare Winner</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="winner-form">
                        <input type="hidden" id="winner-tournament-id">
                        <label class="form-label">Select Winner from Joined Players</label>
                        <select id="winner-select" class="form-select" required></select>
                        <button type="submit" class="btn btn-primary mt-3">Declare Winner</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Post Modal -->
    <div class="modal fade" id="postModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title gold-text" id="post-modal-title">Create New Post</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="post-form">
                        <input type="hidden" id="post-id">
                        <div class="mb-3">
                            <label class="form-label">Title</label>
                            <input type="text" id="post-title" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Content</label>
                            <textarea id="post-content" class="form-control" rows="6" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Category</label>
                                <select id="post-category" class="form-select" required>
                                    <option value="">Select Category</option>
                                    <option value="news">News</option>
                                    <option value="updates">Updates</option>
                                    <option value="tournaments">Tournaments</option>
                                    <option value="tips">Tips & Tricks</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Status</label>
                                <select id="post-status" class="form-select" required>
                                    <option value="draft">Draft</option>
                                    <option value="published">Published</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Featured Image</label>
                            <input type="file" id="post-image" class="form-control" accept="image/*">
                            <div class="form-text">Recommended size: 1200x630 pixels</div>
                        </div>
                        <div id="post-image-preview" class="mb-3 text-center"></div>
                        <button type="submit" class="btn btn-primary">Save Post</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Player Management Modal -->
    <div class="modal fade" id="playerManagementModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title gold-text" id="player-management-title">Manage Tournament Players</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Joined Players</h6>
                        <input type="text" id="player-search-input" class="form-control form-control-sm w-50" placeholder="Search players...">
                    </div>
                    <div id="tournament-players-list">
                        <!-- Players will be loaded here -->
                    </div>
                    <div id="no-players-message" class="text-center py-4 d-none">
                        <i class="bi bi-people display-4 text-muted"></i>
                        <p class="mt-2 text-muted">No players have joined this tournament yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
      <div id="adminToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header"><strong class="me-auto gold-text" id="toast-title">Notification</strong><button type="button" class="btn-close" data-bs-dismiss="toast"></button></div>
        <div class="toast-body" id="toast-body"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAhSjh1VxQFrzslIwOZ1yOxLYuNT2Le_sg",
            authDomain: "fram-and-go.firebaseapp.com",
            databaseURL: "https://fram-and-go-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "fram-and-go",
            storageBucket: "fram-and-go.firebasestorage.app",
            messagingSenderId: "781295119002",
            appId: "1:781295119002:web:3d84890a0bb85e5d1c0d23",
            measurementId: "G-H30RNBNE6X"
        };
        const IMGBB_API_KEY = "a5e9f23952de30236c940c60b740ec9d";

        const app = initializeApp(firebaseConfig);
        const db = getDatabase();

        // Global state
        let allUsers = {};
        let allTournaments = {};
        let allTransactions = {};
        let allPosts = {};
        let allChats = {};
        let activeChatUserId = null;
        let currentAdminId = "admin"; // Hardcoded admin ID

        const adminToast = new bootstrap.Toast(document.getElementById('adminToast'));
        const showToast = (title, message, type='info') => {
            document.getElementById('toast-title').textContent = title;
            document.getElementById('toast-body').textContent = message;
            adminToast.show();
        };

        const uploadImage = async (file) => {
            if (!file) return null;
            const formData = new FormData();
            formData.append('image', file);
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                const result = await response.json();
                return result.success ? result.data.url : null;
            } catch (error) {
                showToast("Error", "Image upload failed.", 'danger');
                return null;
            }
        };

        // --- AUTH ---
        document.getElementById('admin-login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const pass = document.getElementById('admin-password').value;
            // IMPORTANT: This is NOT secure. In a real app, use Firebase Auth with custom admin claims.
            if (pass === 'admin321') {
                document.getElementById('admin-login-overlay').style.display = 'none';
                document.getElementById('admin-content').style.visibility = 'visible';
                initializeAppListeners();
            } else {
                alert('Incorrect password.');
            }
        });

        // --- APP INIT ---
        function initializeAppListeners() {
            onValue(ref(db, 'users'), s => { allUsers = s.val() || {}; renderPlayers(); updateDashboardStats(); updateAuthorFilter(); });
            onValue(ref(db, 'tournaments'), s => { allTournaments = s.val() || {}; renderTournaments(); renderMyTournaments(); updateDashboardStats(); });
            onValue(ref(db, 'transactions'), s => { allTransactions = s.val() || {}; renderTransactions(); updateDashboardStats(); });
            onValue(ref(db, 'posts'), s => { allPosts = s.val() || {}; renderPosts(); updateDashboardStats(); });
            onValue(ref(db, 'banners'), s => { renderBannerPreviews(s.val() || {}); });
            onValue(ref(db, 'supportChats'), s => { allChats = s.val() || {}; renderSupportTickets(); if (activeChatUserId) renderChatMessages(activeChatUserId); updateDashboardStats(); });
        }
        
        // --- NAVIGATION ---
        document.getElementById('admin-nav').addEventListener('click', (e) => {
            e.preventDefault();
            const link = e.target.closest('.nav-link');
            if (!link) return;

            document.querySelectorAll('#admin-nav .nav-link').forEach(l => l.classList.remove('active'));
            link.classList.add('active');

            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(link.dataset.page).classList.add('active');
        });

        // --- DASHBOARD ---
        function updateDashboardStats() {
            document.getElementById('stat-total-players').textContent = Object.keys(allUsers).length;
            document.getElementById('stat-total-tournaments').textContent = Object.keys(allTournaments).length;
            const pendingTxns = Object.values(allTransactions).filter(t => t.status === 'pending').length;
            document.getElementById('stat-pending-txns').textContent = pendingTxns;
            const unreadTickets = Object.values(allChats).filter(c => c.isReadByAdmin === false).length;
            document.getElementById('stat-support-tickets').textContent = unreadTickets;
        }

        // --- PLAYER MANAGEMENT ---
        function renderPlayers(filter = '') {
            const tbody = document.getElementById('players-table-body');
            tbody.innerHTML = '';
            filter = filter.toLowerCase();

            Object.entries(allUsers).forEach(([uid, user]) => {
                if (user.name.toLowerCase().includes(filter) || user.ffId?.toLowerCase().includes(filter)) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.ffId || 'N/A'}</td>
                        <td>${user.role}</td>
                        <td>à§³${user.wallet || 0}</td>
                        <td>
                            <button class="btn btn-sm btn-${user.role === 'moderator' ? 'secondary' : 'info'} toggle-mod-btn" data-uid="${uid}">
                                ${user.role === 'moderator' ? 'Remove Mod' : 'Make Mod'}
                            </button>
                            <button class="btn btn-sm btn-${user.banStatus ? 'success' : 'danger'} ban-btn" data-uid="${uid}">
                                ${user.banStatus ? 'Unban' : 'Ban'}
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            });
        }
        document.getElementById('player-search').addEventListener('input', e => renderPlayers(e.target.value));
        document.getElementById('players-table-body').addEventListener('click', e => {
            const uid = e.target.dataset.uid;
            if (!uid) return;
            if (e.target.classList.contains('toggle-mod-btn')) {
                const newRole = allUsers[uid].role === 'moderator' ? 'player' : 'moderator';
                update(ref(db, `users/${uid}`), { role: newRole });
            }
            if (e.target.classList.contains('ban-btn')) {
                const newStatus = !allUsers[uid].banStatus;
                update(ref(db, `users/${uid}`), { banStatus: newStatus });
            }
        });
        
        // --- TOURNAMENT MANAGEMENT ---
        const tournamentModal = new bootstrap.Modal(document.getElementById('tournamentModal'));
        const tournamentForm = document.getElementById('tournament-form');
        
        function renderTournaments() {
            const tbody = document.getElementById('tournaments-table-body');
            tbody.innerHTML = '';
            Object.entries(allTournaments).forEach(([id, t]) => {
                const playerCount = t.joinedPlayers ? Object.keys(t.joinedPlayers).length : 0;
                const maxPlayers = t.maxPlayers || 100;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${t.name}</td>
                    <td>${t.type}</td>
                    <td>${new Date(t.date).toLocaleString()}</td>
                    <td>à§³${t.entryFee}</td>
                    <td><span class="badge slot-badge">${playerCount}/${maxPlayers}</span></td>
                    <td>${t.status}</td>
                    <td>${playerCount}</td>
                    <td>${t.winner ? `ðŸ‘‘ ${t.winner.name}` : 'None'}</td>
                    <td>
                        <button class="btn btn-sm btn-info edit-t-btn" data-id="${id}">Edit</button>
                        <button class="btn btn-sm btn-warning winner-t-btn" data-id="${id}">Winner</button>
                        <button class="btn btn-sm btn-danger delete-t-btn" data-id="${id}">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function renderMyTournaments() {
            const container = document.getElementById('my-tournaments-container');
            const loading = document.getElementById('my-tournaments-loading');
            const noTournaments = document.getElementById('no-my-tournaments');
            
            loading.classList.add('d-none');
            
            // Filter tournaments created by current admin
            const myTournaments = Object.entries(allTournaments).filter(([id, t]) => t.createdBy === currentAdminId);
            
            if (myTournaments.length === 0) {
                noTournaments.classList.remove('d-none');
                container.innerHTML = '';
                return;
            }
            
            noTournaments.classList.add('d-none');
            container.innerHTML = '';
            
            const searchTerm = document.getElementById('my-tournament-search').value.toLowerCase();
            
            myTournaments.forEach(([id, tournament]) => {
                if (searchTerm && !tournament.name.toLowerCase().includes(searchTerm)) {
                    return;
                }
                
                const playerCount = tournament.joinedPlayers ? Object.keys(tournament.joinedPlayers).length : 0;
                const maxPlayers = tournament.maxPlayers || 100;
                
                const card = document.createElement('div');
                card.className = 'card mb-4 gold-glow';
                card.innerHTML = `
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 gold-text">${tournament.name}</h5>
                        <span class="badge bg-${tournament.status === 'Open' ? 'success' : tournament.status === 'Full' ? 'warning' : 'danger'}">${tournament.status}</span>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <p><strong>Type:</strong> ${tournament.type}</p>
                                <p><strong>Date:</strong> ${new Date(tournament.date).toLocaleString()}</p>
                                <p><strong>Entry Fee:</strong> à§³${tournament.entryFee}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Players:</strong> <span class="badge slot-badge">${playerCount}/${maxPlayers}</span></p>
                                <p><strong>Prize Pool:</strong> ${tournament.prizePool}</p>
                                <p><strong>Winner:</strong> ${tournament.winner ? tournament.winner.name : 'Not decided yet'}</p>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-sm btn-primary manage-players-btn" data-id="${id}">
                                <i class="bi bi-people-fill me-1"></i> Manage Players (${playerCount})
                            </button>
                            <div>
                                <button class="btn btn-sm btn-info edit-t-btn" data-id="${id}">Edit</button>
                                <button class="btn btn-sm btn-warning winner-t-btn" data-id="${id}">Winner</button>
                                <button class="btn btn-sm btn-danger delete-t-btn" data-id="${id}">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // Search for my tournaments
        document.getElementById('my-tournament-search').addEventListener('input', renderMyTournaments);
        
        tournamentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('tournament-id').value;
            const imageFile = document.getElementById('t-poster').files[0];
            let posterUrl = allTournaments[id]?.poster || null;

            if (imageFile) {
                posterUrl = await uploadImage(imageFile);
                if (!posterUrl) return; // Stop if upload fails
            }
            
            const data = {
                name: document.getElementById('t-name').value,
                type: document.getElementById('t-type').value,
                date: document.getElementById('t-date').value,
                prizePool: document.getElementById('t-prize').value,
                entryFee: parseInt(document.getElementById('t-fee').value),
                maxPlayers: parseInt(document.getElementById('t-slots').value),
                status: document.getElementById('t-status').value,
                roomId: document.getElementById('t-room-id').value,
                roomPass: document.getElementById('t-room-pass').value,
                rules: document.getElementById('t-rules').value,
                poster: posterUrl,
                createdBy: currentAdminId,
                timestamp: serverTimestamp()
            };
            
            const refPath = id ? `tournaments/${id}` : push(ref(db, 'tournaments'));
            set(refPath, { ...allTournaments[id], ...data })
                .then(() => { 
                    showToast('Success', 'Tournament saved.'); 
                    tournamentModal.hide(); 
                })
                .catch(err => showToast('Error', err.message));
        });
        
        // Player Management Modal
        const playerManagementModal = new bootstrap.Modal(document.getElementById('playerManagementModal'));
        let currentTournamentId = null;
        
        function renderTournamentPlayers(tournamentId, searchTerm = '') {
            const container = document.getElementById('tournament-players-list');
            const noPlayers = document.getElementById('no-players-message');
            container.innerHTML = '';
            
            const tournament = allTournaments[tournamentId];
            if (!tournament.joinedPlayers || Object.keys(tournament.joinedPlayers).length === 0) {
                noPlayers.classList.remove('d-none');
                return;
            }
            
            noPlayers.classList.add('d-none');
            
            Object.entries(tournament.joinedPlayers).forEach(([playerId, player]) => {
                if (searchTerm && !player.name.toLowerCase().includes(searchTerm.toLowerCase())) {
                    return;
                }
                
                const playerItem = document.createElement('div');
                playerItem.className = 'player-list-item';
                playerItem.innerHTML = `
                    <div>
                        <strong>${player.name}</strong>
                        <div class="small text-muted">FF ID: ${player.ffId || 'N/A'}</div>
                    </div>
                    <button class="btn btn-sm btn-danger remove-player-btn" data-player-id="${playerId}">
                        <i class="bi bi-x-circle"></i> Remove
                    </button>
                `;
                container.appendChild(playerItem);
            });
        }
        
        // Search players in tournament
        document.getElementById('player-search-input').addEventListener('input', (e) => {
            if (currentTournamentId) {
                renderTournamentPlayers(currentTournamentId, e.target.value);
            }
        });
        
        // Remove player from tournament
        document.getElementById('tournament-players-list').addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-player-btn') || e.target.closest('.remove-player-btn')) {
                const playerId = e.target.dataset.playerId || e.target.closest('.remove-player-btn').dataset.playerId;
                if (currentTournamentId && playerId && confirm('Are you sure you want to remove this player from the tournament?')) {
                    const updates = {};
                    updates[`/tournaments/${currentTournamentId}/joinedPlayers/${playerId}`] = null;
                    
                    // Refund entry fee if tournament hasn't started
                    const tournament = allTournaments[currentTournamentId];
                    const currentDate = new Date();
                    const tournamentDate = new Date(tournament.date);
                    
                    if (currentDate < tournamentDate) {
                        const player = allUsers[playerId];
                        if (player) {
                            const currentWallet = player.wallet || 0;
                            updates[`/users/${playerId}/wallet`] = currentWallet + tournament.entryFee;
                        }
                    }
                    
                    update(ref(db), updates)
                        .then(() => {
                            showToast('Success', 'Player removed from tournament.');
                            renderTournamentPlayers(currentTournamentId);
                        })
                        .catch(err => showToast('Error', err.message));
                }
            }
        });
        
        document.getElementById('tournaments').addEventListener('click', e => {
            const id = e.target.dataset.id;
            if (!id) return;
            
            if (e.target.classList.contains('edit-t-btn')) {
                const t = allTournaments[id];
                document.getElementById('tournament-id').value = id;
                document.getElementById('t-name').value = t.name;
                document.getElementById('t-type').value = t.type;
                document.getElementById('t-date').value = t.date;
                document.getElementById('t-prize').value = t.prizePool;
                document.getElementById('t-fee').value = t.entryFee;
                document.getElementById('t-slots').value = t.maxPlayers || 100;
                document.getElementById('t-status').value = t.status;
                document.getElementById('t-room-id').value = t.roomId || '';
                document.getElementById('t-room-pass').value = t.roomPass || '';
                document.getElementById('t-rules').value = t.rules;
                document.getElementById('tournament-modal-title').textContent = 'Edit Tournament';
                tournamentModal.show();
            }
            if (e.target.classList.contains('delete-t-btn')) {
                if (confirm('Are you sure you want to delete this tournament?')) {
                    remove(ref(db, `tournaments/${id}`));
                }
            }
            if(e.target.classList.contains('winner-t-btn')) {
                const t = allTournaments[id];
                const select = document.getElementById('winner-select');
                select.innerHTML = '';
                if (t.joinedPlayers) {
                    Object.entries(t.joinedPlayers).forEach(([uid, player]) => {
                        select.innerHTML += `<option value="${uid}">${player.name} (${player.ffId})</option>`;
                    });
                }
                document.getElementById('winner-tournament-id').value = id;
                new bootstrap.Modal(document.getElementById('winnerModal')).show();
            }
            if (e.target.classList.contains('manage-players-btn')) {
                currentTournamentId = id;
                const tournament = allTournaments[id];
                document.getElementById('player-management-title').textContent = `Manage Players - ${tournament.name}`;
                document.getElementById('player-search-input').value = '';
                renderTournamentPlayers(id);
                playerManagementModal.show();
            }
        });

        document.getElementById('winner-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const tourneyId = document.getElementById('winner-tournament-id').value;
            const winnerId = document.getElementById('winner-select').value;
            const winnerName = document.getElementById('winner-select').options[document.getElementById('winner-select').selectedIndex].text;
            
            update(ref(db, `tournaments/${tourneyId}`), {
                winner: { uid: winnerId, name: winnerName },
                status: 'Closed'
            }).then(() => {
                showToast('Success', 'Winner declared!');
                bootstrap.Modal.getInstance(document.getElementById('winnerModal')).hide();
            });
        });
        
        document.querySelector('#tournamentModal .btn-close').addEventListener('click', () => tournamentForm.reset());


        // --- TRANSACTIONS ---
        function renderTransactions() {
            const depositsTbody = document.getElementById('deposits-table-body');
            const withdrawsTbody = document.getElementById('withdraws-table-body');
            depositsTbody.innerHTML = '';
            withdrawsTbody.innerHTML = '';
            
            Object.entries(allTransactions).forEach(([txId, tx]) => {
                if (tx.status !== 'pending') return;
                const user = allUsers[tx.uid] || {name: 'Unknown User'};
                const row = document.createElement('tr');
                if (tx.type === 'deposit') {
                    row.innerHTML = `
                        <td>${user.name}</td>
                        <td>${tx.method}</td>
                        <td>à§³${tx.amount}</td>
                        <td>${tx.phone}</td>
                        <td>${tx.transactionId}</td>
                        <td>
                            <button class="btn btn-sm btn-success approve-tx-btn" data-txid="${txId}">Approve</button>
                            <button class="btn btn-sm btn-danger reject-tx-btn" data-txid="${txId}">Reject</button>
                        </td>
                    `;
                    depositsTbody.appendChild(row);
                } else { // withdraw
                     row.innerHTML = `
                        <td>${user.name}</td>
                        <td>${tx.method}</td>
                        <td>à§³${tx.amount}</td>
                        <td>${tx.account}</td>
                        <td>
                            <button class="btn btn-sm btn-success approve-tx-btn" data-txid="${txId}">Approve</button>
                            <button class="btn btn-sm btn-danger reject-tx-btn" data-txid="${txId}">Reject</button>
                        </td>
                    `;
                    withdrawsTbody.appendChild(row);
                }
            });
        }
        
        document.getElementById('transactions').addEventListener('click', e => {
            const txId = e.target.dataset.txid;
            if (!txId) return;
            const tx = allTransactions[txId];
            
            if (e.target.classList.contains('approve-tx-btn')) {
                const updates = {};
                updates[`/transactions/${txId}/status`] = 'approved';
                const currentWallet = allUsers[tx.uid].wallet || 0;
                const newWallet = tx.type === 'deposit' ? currentWallet + tx.amount : currentWallet - tx.amount;
                updates[`/users/${tx.uid}/wallet`] = newWallet;
                update(ref(db), updates);
            }
            if (e.target.classList.contains('reject-tx-btn')) {
                update(ref(db, `transactions/${txId}`), { status: 'rejected' });
            }
        });
        
        // --- POST MANAGEMENT ---
        const postModal = new bootstrap.Modal(document.getElementById('postModal'));
        const postForm = document.getElementById('post-form');
        
        function renderPosts() {
            const container = document.getElementById('posts-container');
            const loading = document.getElementById('posts-loading');
            const noPosts = document.getElementById('no-posts');
            
            loading.classList.add('d-none');
            
            if (!allPosts || Object.keys(allPosts).length === 0) {
                noPosts.classList.remove('d-none');
                container.innerHTML = '';
                return;
            }
            
            noPosts.classList.add('d-none');
            container.innerHTML = '';
            
            const searchTerm = document.getElementById('post-search').value.toLowerCase();
            const statusFilter = document.getElementById('post-status-filter').value;
            const authorFilter = document.getElementById('post-author-filter').value;
            
            Object.entries(allPosts).forEach(([postId, post]) => {
                // Apply filters
                if (searchTerm && !post.title.toLowerCase().includes(searchTerm) && 
                    !post.content.toLowerCase().includes(searchTerm)) {
                    return;
                }
                
                if (statusFilter !== 'all' && post.status !== statusFilter) {
                    return;
                }
                
                if (authorFilter !== 'all' && post.authorId !== authorFilter) {
                    return;
                }
                
                const author = allUsers[post.authorId] || {name: 'Unknown', profileImage: ''};
                const postDate = post.timestamp ? new Date(post.timestamp).toLocaleDateString() : 'Unknown date';
                
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4';
                col.innerHTML = `
                    <div class="post-card h-100">
                        <div class="position-relative">
                            ${post.imageUrl ? 
                                `<img src="${post.imageUrl}" class="post-image" alt="${post.title}">` : 
                                `<div class="post-image bg-secondary d-flex align-items-center justify-content-center">
                                    <i class="bi bi-image text-muted display-4"></i>
                                </div>`
                            }
                            <span class="post-status-badge badge bg-${post.status === 'published' ? 'success' : 'warning'}">
                                ${post.status === 'published' ? 'Published' : 'Draft'}
                            </span>
                        </div>
                        <div class="p-3">
                            <h5 class="mb-2">${post.title}</h5>
                            <p class="text-muted small mb-2">${post.content.substring(0, 100)}${post.content.length > 100 ? '...' : ''}</p>
                            <div class="d-flex align-items-center mb-3">
                                ${author.profileImage ? 
                                    `<img src="${author.profileImage}" class="post-author-img me-2" alt="${author.name}">` :
                                    `<div class="post-author-img bg-primary text-white d-flex align-items-center justify-content-center me-2">
                                        <i class="bi bi-person"></i>
                                    </div>`
                                }
                                <div>
                                    <div class="small">${author.name}</div>
                                    <div class="text-muted smaller">${postDate}</div>
                                </div>
                            </div>
                            <div class="post-actions">
                                <button class="btn btn-sm btn-primary edit-post-btn" data-id="${postId}">Edit</button>
                                <button class="btn btn-sm btn-${post.status === 'published' ? 'warning' : 'success'} toggle-post-status-btn" data-id="${postId}">
                                    ${post.status === 'published' ? 'Unpublish' : 'Publish'}
                                </button>
                                <button class="btn btn-sm btn-danger delete-post-btn" data-id="${postId}">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(col);
            });
            
            if (container.innerHTML === '') {
                noPosts.classList.remove('d-none');
            }
        }
        
        function updateAuthorFilter() {
            const authorFilter = document.getElementById('post-author-filter');
            const currentValue = authorFilter.value;
            
            // Clear existing options except "All Authors"
            authorFilter.innerHTML = '<option value="all">All Authors</option>';
            
            // Add moderators and admins to the filter
            Object.entries(allUsers).forEach(([uid, user]) => {
                if (user.role === 'moderator' || user.role === 'admin') {
                    authorFilter.innerHTML += `<option value="${uid}">${user.name}</option>`;
                }
            });
            
            // Restore previous selection if possible
            if (currentValue && Array.from(authorFilter.options).some(opt => opt.value === currentValue)) {
                authorFilter.value = currentValue;
            }
        }
        
        // Post search and filter event listeners
        document.getElementById('post-search').addEventListener('input', renderPosts);
        document.getElementById('post-status-filter').addEventListener('change', renderPosts);
        document.getElementById('post-author-filter').addEventListener('change', renderPosts);
        
        // Post form submission
        postForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const postId = document.getElementById('post-id').value;
            const imageFile = document.getElementById('post-image').files[0];
            let imageUrl = allPosts[postId]?.imageUrl || null;
            
            if (imageFile) {
                imageUrl = await uploadImage(imageFile);
                if (!imageUrl) return; // Stop if upload fails
            }
            
            const data = {
                title: document.getElementById('post-title').value,
                content: document.getElementById('post-content').value,
                category: document.getElementById('post-category').value,
                status: document.getElementById('post-status').value,
                imageUrl: imageUrl,
                authorId: 'admin', // Hardcoded as admin for now
                timestamp: postId ? allPosts[postId].timestamp : serverTimestamp(),
                lastUpdated: serverTimestamp()
            };
            
            const refPath = postId ? `posts/${postId}` : push(ref(db, 'posts'));
            set(refPath, { ...allPosts[postId], ...data })
                .then(() => { 
                    showToast('Success', 'Post saved successfully.'); 
                    postModal.hide(); 
                    postForm.reset();
                    document.getElementById('post-image-preview').innerHTML = '';
                })
                .catch(err => showToast('Error', err.message));
        });
        
        // Post actions
        document.getElementById('posts-container').addEventListener('click', e => {
            const postId = e.target.dataset.id;
            if (!postId) return;
            
            if (e.target.classList.contains('edit-post-btn')) {
                const post = allPosts[postId];
                document.getElementById('post-id').value = postId;
                document.getElementById('post-title').value = post.title;
                document.getElementById('post-content').value = post.content;
                document.getElementById('post-category').value = post.category || '';
                document.getElementById('post-status').value = post.status;
                
                // Show image preview if exists
                const preview = document.getElementById('post-image-preview');
                if (post.imageUrl) {
                    preview.innerHTML = `<img src="${post.imageUrl}" class="img-fluid rounded" style="max-height: 200px;">`;
                } else {
                    preview.innerHTML = '';
                }
                
                document.getElementById('post-modal-title').textContent = 'Edit Post';
                postModal.show();
            }
            
            if (e.target.classList.contains('toggle-post-status-btn')) {
                const post = allPosts[postId];
                const newStatus = post.status === 'published' ? 'draft' : 'published';
                update(ref(db, `posts/${postId}`), { status: newStatus })
                    .then(() => showToast('Success', `Post ${newStatus === 'published' ? 'published' : 'unpublished'}.`));
            }
            
            if (e.target.classList.contains('delete-post-btn')) {
                if (confirm('Are you sure you want to delete this post?')) {
                    remove(ref(db, `posts/${postId}`))
                        .then(() => showToast('Success', 'Post deleted.'));
                }
            }
        });
        
        // Reset post form when modal is closed
        document.querySelector('#postModal .btn-close').addEventListener('click', () => {
            postForm.reset();
            document.getElementById('post-image-preview').innerHTML = '';
        });
        
        // Clear post form when creating new post
        document.querySelector('[data-bs-target="#postModal"]').addEventListener('click', () => {
            document.getElementById('post-id').value = '';
            document.getElementById('post-title').value = '';
            document.getElementById('post-content').value = '';
            document.getElementById('post-category').value = '';
            document.getElementById('post-status').value = 'draft';
            document.getElementById('post-image').value = '';
            document.getElementById('post-image-preview').innerHTML = '';
            document.getElementById('post-modal-title').textContent = 'Create New Post';
        });
        
        // --- BANNERS ---
        function renderBannerPreviews(banners) {
            if (banners.mainBanner) {
                document.getElementById('main-banner-preview').innerHTML = `<img src="${banners.mainBanner}" class="img-fluid rounded">`;
            }
            if (banners.announcement && banners.announcement.imageUrl) {
                 document.getElementById('announcement-banner-preview').innerHTML = `<img src="${banners.announcement.imageUrl}" class="img-fluid rounded">`;
                 document.getElementById('announcement-active-toggle').checked = banners.announcement.active;
            }
        }
        
        document.getElementById('main-banner-form').addEventListener('submit', async e => {
            e.preventDefault();
            const file = document.getElementById('main-banner-upload').files[0];
            if (file) {
                const url = await uploadImage(file);
                if (url) set(ref(db, 'banners/mainBanner'), url).then(() => showToast('Success', 'Main banner updated.'));
            }
        });
        
        document.getElementById('announcement-banner-form').addEventListener('submit', async e => {
            e.preventDefault();
            const file = document.getElementById('announcement-banner-upload').files[0];
            const isActive = document.getElementById('announcement-active-toggle').checked;
            
            let url = allChats?.announcement?.imageUrl || null;
            if (file) url = await uploadImage(file);
            
            if (url) {
                set(ref(db, 'banners/announcement'), { imageUrl: url, active: isActive }).then(() => showToast('Success', 'Announcement banner updated.'));
            } else if (!file) { // if only toggle is changed
                update(ref(db, 'banners/announcement'), { active: isActive }).then(() => showToast('Success', 'Announcement status updated.'));
            }
        });
        
        // --- SUPPORT ---
        function renderSupportTickets() {
            const list = document.getElementById('support-tickets-list');
            list.innerHTML = '';
            Object.entries(allChats).forEach(([uid, chat]) => {
                const user = allUsers[uid] || {name: 'Unknown User'};
                const isUnread = chat.isReadByAdmin === false;
                const item = document.createElement('a');
                item.href = '#';
                item.className = `list-group-item list-group-item-action ${isUnread ? 'fw-bold' : ''}`;
                item.dataset.uid = uid;
                item.innerHTML = `${user.name} ${isUnread ? '<span class="badge bg-primary float-end">New</span>' : ''}`;
                list.appendChild(item);
            });
        }
        
        document.getElementById('support-tickets-list').addEventListener('click', e => {
            e.preventDefault();
            const item = e.target.closest('a');
            if (item) {
                const uid = item.dataset.uid;
                activeChatUserId = uid;
                document.getElementById('support-chat-placeholder').classList.add('d-none');
                document.getElementById('support-chat-view').classList.remove('d-none');
                document.getElementById('chat-user-name').textContent = `Chat with ${allUsers[uid].name}`;
                renderChatMessages(uid);
                update(ref(db, `supportChats/${uid}`), {isReadByAdmin: true});
            }
        });
        
        function renderChatMessages(uid) {
            const container = document.getElementById('admin-chat-messages');
            container.innerHTML = '';
            const messages = Object.values(allChats[uid]?.messages || {}).sort((a, b) => a.timestamp - b.timestamp);
            messages.reverse().forEach(msg => {
                const isAdmin = msg.sender === 'admin';
                const div = document.createElement('div');
                div.className = `p-2 my-1 rounded w-75 ${isAdmin ? 'ms-auto bg-primary' : 'me-auto'}`;
                div.style.backgroundColor = isAdmin ? '' : '#444';
                div.innerHTML = `<div class="small">${msg.text}</div>`;
                container.appendChild(div);
            });
        }
        
        document.getElementById('admin-chat-form').addEventListener('submit', e => {
            e.preventDefault();
            if (!activeChatUserId) return;
            const input = document.getElementById('admin-chat-input');
            const text = input.value.trim();
            if (text) {
                push(ref(db, `supportChats/${activeChatUserId}/messages`), {
                    sender: 'admin', text, timestamp: serverTimestamp()
                });
                input.value = '';
            }
        });

    </script>
</body>
</html>
