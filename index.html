<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CyberFire Admin Panel</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #6e00ff;
  --secondary: #ff00f7;
  --accent: #00f0ff;
  --dark: #0f0f1a;
  --darker: #0a0a12;
  --card-bg: #1b1b2f;
  --card-border: #2a2a42;
  --text-light: #e0e0ff;
  --text-muted: #8a8aa8;
  --notification-bg: #2a2a42;
  --notification-success: #28a745;
  --notification-error: #dc3545;
  --notification-warning: #ffc107;
}

body {
  background: var(--dark);
  color: var(--text-light);
  font-family: 'Roboto', sans-serif;
  min-height: 100vh;
}

h1, h2, h3, h4, h5, h6 {
  font-family: 'Orbitron', sans-serif;
  font-weight: 700;
}

/* Login Modal */
#login-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.9);
  z-index: 9999;
  display: flex;
  justify-content: center;
  align-items: center;
}

.login-card {
  background: var(--card-bg);
  border: 1px solid var(--primary);
  border-radius: 12px;
  width: 100%;
  max-width: 400px;
  padding: 30px;
  box-shadow: 0 0 30px rgba(110, 0, 255, 0.3);
  animation: glow 2s infinite alternate;
}

@keyframes glow {
  from { box-shadow: 0 0 20px rgba(110, 0, 255, 0.3); }
  to { box-shadow: 0 0 30px rgba(110, 0, 255, 0.6); }
}

/* Main Content */
.container {
  max-width: 1400px;
  padding-top: 20px;
  padding-bottom: 40px;
}

/* Cards */
.card {
  background: var(--card-bg);
  border: 1px solid var(--card-border);
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  transition: all 0.3s ease;
}

.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
}

.card-header {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  border-bottom: 1px solid var(--card-border);
  padding: 15px 20px;
  font-family: 'Orbitron', sans-serif;
  font-weight: 500;
  letter-spacing: 1px;
}

/* Buttons */
.btn-brand {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 500;
  letter-spacing: 0.5px;
  transition: all 0.3s;
  padding: 8px 16px;
}
.btn-brand:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(110, 0, 255, 0.4); color: white; }

.btn-outline-brand { color: var(--primary); border: 1px solid var(--primary); background: transparent; }
.btn-outline-brand:hover { background: var(--primary); color: white; }

.btn-accent { background: var(--accent); color: var(--dark); font-weight: 600; }
.btn-accent:hover { background: #00d9e8; color: var(--dark); }

.btn-deduct { 
  background: linear-gradient(135deg, #ff6b6b, #c0392b);
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 500;
  letter-spacing: 0.5px;
  transition: all 0.3s;
  padding: 8px 16px;
}
.btn-deduct:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4); color: white; }

/* Tables */
.table { color: var(--text-light); margin-bottom: 0; }
.table thead th { color: var(--accent); border-bottom: 2px solid var(--primary); font-family: 'Orbitron', sans-serif; font-weight: 500; letter-spacing: 0.5px; }
.table tbody tr { transition: all 0.2s; }
.table tbody tr:hover { background: rgba(110, 0, 255, 0.1); }
.table td, .table th { padding: 12px 15px; vertical-align: middle; border-top: 1px solid var(--card-border); }

/* Status Badges */
.badge-pill { border-radius: 12px; padding: 5px 12px; font-weight: 500; font-size: 0.8rem; }
.badge-pending { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
.badge-approved { background: rgba(40, 167, 69, 0.2); color: #28a745; }
.badge-rejected { background: rgba(220, 53, 69, 0.2); color: #dc3545; }
.badge-banned { background: rgba(220, 53, 69, 0.2); color: #dc3545; }
.badge-verified { background: rgba(0, 240, 255, 0.2); color: var(--accent); }

/* Icons */
.icon { margin-right: 8px; }
.blue-tick { color: var(--accent); }

/* Navbar */
.admin-navbar { background: var(--darker); border-bottom: 1px solid var(--primary); padding: 15px 0; }
.admin-navbar .navbar-brand { font-family: 'Orbitron', sans-serif; font-weight: 700; color: white; font-size: 1.5rem; letter-spacing: 1px; }
.admin-navbar .navbar-brand span { color: var(--accent); }
.admin-navbar .nav-link { color: var(--text-light); font-family: 'Orbitron', sans-serif; font-weight: 500; margin: 0 10px; letter-spacing: 0.5px; }
.admin-navbar .nav-link:hover { color: var(--accent); }
.admin-navbar .nav-link.active { color: var(--accent); border-bottom: 2px solid var(--accent); }

/* Stats Cards */
.stats-card { text-align: center; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
.stats-card .stats-value { font-size: 2.5rem; font-weight: 700; font-family: 'Orbitron', sans-serif; margin: 10px 0; color: var(--accent); }
.stats-card .stats-label { color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }

/* Notification System */
.notification-container { position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 350px; width: 100%; }
.notification { background: var(--notification-bg); border-left: 4px solid var(--primary); border-radius: 6px; padding: 15px; margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: flex; align-items: center; transform: translateX(120%); transition: all 0.3s ease; }
.notification.show { transform: translateX(0); }
.notification.success { border-left-color: var(--notification-success); }
.notification.error { border-left-color: var(--notification-error); }
.notification.warning { border-left-color: var(--notification-warning); }
.notification-icon { font-size: 1.5rem; margin-right: 15px; }
.notification-content { flex: 1; }
.notification-close { background: none; border: none; color: var(--text-muted); font-size: 1.2rem; cursor: pointer; margin-left: 10px; }

/* Tabs */
.nav-tabs { border-bottom: 1px solid var(--card-border); }
.nav-tabs .nav-link { color: var(--text-muted); border: 1px solid transparent; border-top-left-radius: 8px; border-top-right-radius: 8px; font-family: 'Orbitron', sans-serif; font-weight: 500; }
.nav-tabs .nav-link:hover { border-color: transparent; color: var(--accent); }
.nav-tabs .nav-link.active { color: var(--accent); background: transparent; border-color: var(--card-border) var(--card-border) var(--card-bg); }
.tab-content { padding: 20px 0; }

/* Responsive */
@media (max-width: 768px) {
  .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .admin-navbar .nav-link { margin: 5px 0; padding: 8px 15px; }
  .notification-container { top: 10px; right: 10px; max-width: calc(100% - 20px); }
}

/* Action Buttons */
.action-buttons .btn { margin-right: 5px; margin-bottom: 5px; }

/* Modal Enhancements */
.modal-content { background: var(--card-bg); color: var(--text-light); border: 1px solid var(--primary); border-radius: 12px; }
.modal-header { border-bottom: 1px solid var(--card-border); }
.modal-footer { border-top: 1px solid var(--card-border); }
.btn-close { filter: invert(1); }

/* Custom Scrollbar */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--darker); }
::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--secondary); }
</style>
</head>
<body>

<!-- Notification Container -->
<div class="notification-container" id="notification-container"></div>

<!-- Login Modal -->
<div id="login-modal">
  <div class="login-card">
    <div class="text-center mb-4">
      <h2><i class="fas fa-shield-alt"></i> Admin Access</h2>
      <p class="text-muted">Enter password to continue</p>
    </div>
    <div class="mb-3">
      <input type="password" id="admin-password" class="form-control form-control-lg" placeholder="Enter Password" autocomplete="current-password">
      <div id="password-error" class="text-danger mt-2" style="display: none;">Incorrect password</div>
    </div>
    <button id="btn-login" class="btn btn-brand w-100">
      <i class="fas fa-sign-in-alt"></i> Login
    </button>
  </div>
</div>

<!-- Admin Navbar -->
<nav class="admin-navbar navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <a class="navbar-brand" href="#"><i class="fas fa-fire"></i> Cyber<span>Fire</span></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#adminNav"><span class="navbar-toggler-icon"></span></button>
    <div class="collapse navbar-collapse" id="adminNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link active" href="#users"><i class="fas fa-users"></i> Users</a></li>
        <li class="nav-item"><a class="nav-link" href="#deposits"><i class="fas fa-money-bill-wave"></i> Deposits</a></li>
        <li class="nav-item"><a class="nav-link" href="#withdrawals"><i class="fas fa-hand-holding-usd"></i> Withdrawals</a></li>
        <li class="nav-item"><a class="nav-link" href="#tournaments"><i class="fas fa-trophy"></i> Tournaments</a></li>
        <li class="nav-item"><a class="nav-link" href="#analytics"><i class="fas fa-chart-line"></i> Analytics</a></li>
        <li class="nav-item"><a class="nav-link" href="#activity"><i class="fas fa-list-check"></i> Activity</a></li>
        <li class="nav-item"><a class="nav-link" href="#" id="btn-logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

<!-- Main Content -->
<div class="container" id="admin-content" style="display: none;">

  <!-- Stats Row -->
  <div class="row mb-4">
    <div class="col-md-3"><div class="stats-card card"><i class="fas fa-users fa-2x"></i><div class="stats-value" id="total-users">0</div><div class="stats-label">Total Users</div></div></div>
    <div class="col-md-3"><div class="stats-card card"><i class="fas fa-money-bill-wave fa-2x"></i><div class="stats-value" id="total-deposits">0</div><div class="stats-label">Pending Deposits</div></div></div>
    <div class="col-md-3"><div class="stats-card card"><i class="fas fa-hand-holding-usd fa-2x"></i><div class="stats-value" id="total-withdrawals">0</div><div class="stats-label">Pending Withdrawals</div></div></div>
    <div class="col-md-3"><div class="stats-card card"><i class="fas fa-trophy fa-2x"></i><div class="stats-value" id="total-tournaments">0</div><div class="stats-label">Pending Tournaments</div></div></div>
  </div>

  <!-- USERS -->
  <div class="card" id="users-section">
    <div class="card-header"><h4 class="mb-0"><i class="fas fa-users icon"></i> All Users</h4></div>
    <div class="card-body">
      <ul class="nav nav-tabs" id="usersTab" role="tablist">
        <li class="nav-item" role="presentation"><button class="nav-link active" id="players-tab" data-bs-toggle="tab" data-bs-target="#players" type="button" role="tab">Players</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="organizers-tab" data-bs-toggle="tab" data-bs-target="#organizers" type="button" role="tab">Organizers</button></li>
      </ul>
      <div class="tab-content" id="usersTabContent">
        <div class="tab-pane fade show active" id="players" role="tabpanel">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead><tr><th>Name</th><th>Email</th><th>Referrals</th><th>Wallet</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="players-body"></tbody>
            </table>
          </div>
        </div>
        <div class="tab-pane fade" id="organizers" role="tabpanel">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead><tr><th>Name</th><th>Email</th><th>Referrals</th><th>Wallet</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="organizers-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- DEPOSITS -->
  <div class="card mt-4" id="deposits-section">
    <div class="card-header"><h4 class="mb-0"><i class="fas fa-money-bill-wave icon"></i> Player Deposit Requests</h4></div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead><tr><th>Name</th><th>Email</th><th>Amount</th><th>Number</th><th>Method</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead>
          <tbody id="balance-req-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- WITHDRAWALS (Players + Organizers) -->
  <div class="card mt-4" id="withdrawals-section">
    <div class="card-header"><h4 class="mb-0"><i class="fas fa-hand-holding-usd icon"></i> Withdraw Requests (Players & Organizers)</h4></div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Name</th><th>Email</th><th>Role</th><th>Amount</th><th>Number</th><th>Method</th><th>Status</th><th>Date</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="withdraw-req-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TOURNAMENTS -->
  <div class="card mt-4" id="tournaments-section">
    <div class="card-header"><h4 class="mb-0"><i class="fas fa-trophy icon"></i> All Tournaments</h4></div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead><tr><th>Name</th><th>Organizer</th><th>Fee</th><th>Prize</th><th>Date & Time</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="tournaments-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ANALYTICS (Charts) -->
  <div class="card mt-4" id="analytics-section">
    <div class="card-header"><h4 class="mb-0"><i class="fas fa-chart-line icon"></i> Analytics</h4></div>
    <div class="card-body">
      <div class="row g-4">
        <div class="col-md-6">
          <h6 class="text-muted">Users Overview</h6>
          <canvas id="countsChart" height="200"></canvas>
        </div>
        <div class="col-md-6">
          <h6 class="text-muted">Role Distribution</h6>
          <canvas id="rolesChart" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- ADMIN ACTIVITY -->
  <div class="card mt-4" id="activity-section">
    <div class="card-header"><h4 class="mb-0"><i class="fas fa-list-check icon"></i> Admin Activity</h4></div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead><tr><th>Time</th><th>Action</th><th>Details</th><th>Admin</th></tr></thead>
          <tbody id="activity-body"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- Tournament Edit Modal -->
<div class="modal fade" id="editTournamentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Edit Tournament</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
      <div class="modal-body">
        <form id="edit-tournament-form">
          <input type="hidden" id="edit-tournament-id">
          <div class="row">
            <div class="col-md-6 mb-3"><label for="edit-tournament-name" class="form-label">Tournament Name</label><input type="text" class="form-control" id="edit-tournament-name" required></div>
            <div class="col-md-6 mb-3"><label for="edit-tournament-fee" class="form-label">Entry Fee</label><input type="number" class="form-control" id="edit-tournament-fee" required></div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3"><label for="edit-tournament-prize" class="form-label">Prize Pool</label><input type="text" class="form-control" id="edit-tournament-prize" required></div>
            <div class="col-md-6 mb-3"><label for="edit-tournament-status" class="form-label">Status</label>
              <select class="form-select" id="edit-tournament-status" required>
                <option value="pending">Pending</option><option value="approved">Approved</option><option value="rejected">Rejected</option><option value="completed">Completed</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3"><label for="edit-tournament-date" class="form-label">Date</label><input type="date" class="form-control" id="edit-tournament-date" required></div>
            <div class="col-md-6 mb-3"><label for="edit-tournament-time" class="form-label">Time</label><input type="time" class="form-control" id="edit-tournament-time" required></div>
          </div>
          <div class="mb-3"><label for="edit-tournament-desc" class="form-label">Description</label><textarea class="form-control" id="edit-tournament-desc" rows="3" required></textarea></div>
          <div class="mb-3"><label for="edit-tournament-rules" class="form-label">Rules</label><textarea class="form-control" id="edit-tournament-rules" rows="3" required></textarea></div>
        </form>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button" class="btn btn-brand" id="btn-update-tournament">Update Tournament</button></div>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD1-qeqgWg9-3TW--XnpWQHNTP7-ROhDIs",
  authDomain: "football-manager-cf301.firebaseapp.com",
  databaseURL: "https://football-manager-cf301-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "football-manager-cf301",
  storageBucket: "football-manager-cf301.firebasestorage.app",
  messagingSenderId: "491848692016",
  appId: "1:491848692016:web:dc080692f1c5ee6c5298f5",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Password protection
const ADMIN_PASSWORD = "swampod321";
const ADMIN_NAME = "Admin";
let isAuthenticated = false;

// UI elements
const loginModal = document.getElementById('login-modal');
const adminPassword = document.getElementById('admin-password');
const btnLogin = document.getElementById('btn-login');
const passwordError = document.getElementById('password-error');
const adminContent = document.getElementById('admin-content');
const btnLogout = document.getElementById('btn-logout');
const notificationContainer = document.getElementById('notification-container');
const editTournamentModal = new bootstrap.Modal(document.getElementById('editTournamentModal'));
const btnUpdateTournament = document.getElementById('btn-update-tournament');

// Local users cache for quick lookup
let usersCache = {};
db.ref('users').on('value', snap => { usersCache = snap.val() || {}; });

// Charts
let countsChart = null;
let rolesChart = null;

// Helpers
function logActivity(action, details) {
  db.ref('adminActivity').push({
    action,
    details,
    admin: ADMIN_NAME,
    timestamp: firebase.database.ServerValue.TIMESTAMP
  });
}

// Login
btnLogin.addEventListener('click', () => {
  if (adminPassword.value === ADMIN_PASSWORD) {
    isAuthenticated = true;
    loginModal.style.display = 'none';
    adminContent.style.display = 'block';
    loadAllData();
    setupAnalytics();
    loadAdminActivity();
    showNotification('Login successful', 'Welcome to CyberFire Admin Panel', 'success');
    logActivity('login', 'Admin logged in');
  } else {
    passwordError.style.display = 'block';
    adminPassword.classList.add('is-invalid');
    showNotification('Login failed', 'Incorrect password', 'error');
  }
});

// Logout
btnLogout.addEventListener('click', () => {
  isAuthenticated = false;
  adminContent.style.display = 'none';
  loginModal.style.display = 'flex';
  adminPassword.value = '';
  passwordError.style.display = 'none';
  adminPassword.classList.remove('is-invalid');
  showNotification('Logged out', 'You have been logged out successfully', 'info');
  logActivity('logout', 'Admin logged out');
});

// Notifications
function showNotification(title, message, type = 'info') {
  const el = document.createElement('div');
  el.className = `notification ${type}`;
  el.innerHTML = `
    <div class="notification-icon">
      ${type === 'success' ? '<i class="fas fa-check-circle"></i>' :
        type === 'error' ? '<i class="fas fa-exclamation-circle"></i>' :
        type === 'warning' ? '<i class="fas fa-exclamation-triangle"></i>' :
        '<i class="fas fa-info-circle"></i>'}
    </div>
    <div class="notification-content">
      <h6 class="mb-1">${title}</h6>
      <p class="small mb-0">${message}</p>
    </div>
    <button class="notification-close"><i class="fas fa-times"></i></button>
  `;
  notificationContainer.appendChild(el);
  setTimeout(() => el.classList.add('show'), 50);
  el.querySelector('.notification-close').addEventListener('click', () => { el.classList.remove('show'); setTimeout(() => el.remove(), 300); });
  setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 300); }, 5000);
}

// Smooth nav
document.querySelectorAll('.nav-link').forEach(link => {
  link.addEventListener('click', function(e) {
    const href = this.getAttribute('href');
    if (!href || href === '#') return;
    e.preventDefault();
    const id = href.substring(1);
    document.getElementById(id + '-section')?.scrollIntoView({ behavior: 'smooth' });
    document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
    this.classList.add('active');
  });
});

// Data loaders
function loadAllData() {
  loadPlayers();
  loadOrganizers();
  loadBalanceRequests();
  loadWithdrawRequests();
  loadTournaments();
  loadStats();
}

// Stats
function loadStats() {
  db.ref('users').on('value', snap => {
    const users = snap.val() || {};
    document.getElementById('total-users').textContent = Object.keys(users).length;
  });
  db.ref('paymentRequests').orderByChild('type').equalTo('deposit').on('value', snap => {
    const requests = snap.val() || {};
    let pendingCount = 0;
    Object.values(requests).forEach(req => { if (req.status === 'pending') pendingCount++; });
    document.getElementById('total-deposits').textContent = pendingCount;
  });
  db.ref('paymentRequests').orderByChild('type').equalTo('withdraw').on('value', snap => {
    const requests = snap.val() || {};
    let pendingCount = 0;
    Object.values(requests).forEach(req => { if (req.status === 'pending') pendingCount++; });
    document.getElementById('total-withdrawals').textContent = pendingCount;
  });
  db.ref('tournaments').orderByChild('status').equalTo('pending').on('value', snap => {
    const tournaments = snap.val() || {};
    document.getElementById('total-tournaments').textContent = Object.keys(tournaments).length;
  });
}

// Users: players
function loadPlayers() {
  db.ref('users').orderByChild('role').equalTo('player').on('value', snap => {
    const players = snap.val() || {};
    const body = document.getElementById('players-body');
    body.innerHTML = '';
    Object.entries(players).forEach(([uid, player]) => {
      const tr = document.createElement('tr');
      const statusBadge = player.ban ? '<span class="badge badge-pill badge-banned">Banned</span>' : '<span class="badge badge-pill" style="background: rgba(255,255,255,0.1);">Active</span>';
      tr.innerHTML = `
        <td>${player.name || '-'}</td>
        <td>${player.email || '-'}</td>
        <td><span class="badge badge-pill" style="background: rgba(255, 193, 7, 0.2); color:#ffc107;">${player.referralCount || 0} Referrals</span></td>
        <td>৳${player.wallet || 0}</td>
        <td>${statusBadge}</td>
        <td class="action-buttons">
          <button class="btn btn-sm btn-brand ban-btn" data-uid="${uid}" data-ban="${player.ban || false}">${player.ban ? '<i class="fas fa-unlock me-1"></i> Unban' : '<i class="fas fa-ban me-1"></i> Ban'}</button>
          <button class="btn btn-sm btn-accent ms-1 add-balance-btn" data-uid="${uid}"><i class="fas fa-plus me-1"></i> Add Balance</button>
          <button class="btn btn-sm btn-deduct ms-1 deduct-balance-btn" data-uid="${uid}"><i class="fas fa-minus me-1"></i> Deduct Balance</button>
        </td>
      `;
      body.appendChild(tr);
      tr.querySelector('.ban-btn').addEventListener('click', function() {
        const isBanned = this.getAttribute('data-ban') === 'true';
        db.ref(`users/${uid}/ban`).set(!isBanned).then(() => {
          showNotification(isBanned ? 'Player Unbanned' : 'Player Banned', `${player.name || 'Player'} has been ${isBanned ? 'unbanned' : 'banned'}`, isBanned ? 'success' : 'warning');
          logActivity(!isBanned ? 'ban_user' : 'unban_user', `${player.name || 'Player'} (${uid}) ${!isBanned ? 'banned' : 'unbanned'}`);
          if (!isBanned) {
            const nid = Date.now();
            db.ref(`userNotifications/${uid}/${nid}`).set({ title:'Account Status Update', message:'Your account has been banned by admin. Please contact support.', type:'important', timestamp: firebase.database.ServerValue.TIMESTAMP, read:false });
          }
        }).catch(err => showNotification('Error', err.message, 'error'));
      });
      tr.querySelector('.add-balance-btn').addEventListener('click', function() {
        const amount = prompt(`Enter amount to add to ${player.name || 'player'}'s wallet:`);
        if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
          const amountNum = parseFloat(amount);
          db.ref(`users/${uid}/wallet`).transaction(c => (c || 0) + amountNum).then(() => {
            showNotification('Balance Added', `৳${amountNum} added to ${player.name || 'player'}`, 'success');
            logActivity('add_balance', `Added ৳${amountNum} to ${player.name || 'Player'} (${uid})`);
            const nid = Date.now();
            db.ref(`userNotifications/${uid}/${nid}`).set({ title:'Balance Added', message:`Admin added ৳${amountNum} to your wallet.`, type:'success', timestamp: firebase.database.ServerValue.TIMESTAMP, read:false });
          }).catch(err => showNotification('Error', err.message, 'error'));
        } else if (amount !== null) {
          showNotification('Error', 'Please enter a valid amount', 'error');
        }
      });
      tr.querySelector('.deduct-balance-btn').addEventListener('click', function() {
        const amount = prompt(`Enter amount to deduct from ${player.name || 'player'}'s wallet:`);
        if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
          const amountNum = parseFloat(amount);
          db.ref(`users/${uid}/wallet`).transaction(c => {
            const current = c || 0;
            if (current < amountNum) {
              showNotification('Error', `Player only has ৳${current} in wallet`, 'error');
              return current;
            }
            return current - amountNum;
          }).then(() => {
            showNotification('Balance Deducted', `৳${amountNum} deducted from ${player.name || 'player'}`, 'success');
            logActivity('deduct_balance', `Deducted ৳${amountNum} from ${player.name || 'Player'} (${uid})`);
            const nid = Date.now();
            db.ref(`userNotifications/${uid}/${nid}`).set({ title:'Balance Deducted', message:`Admin deducted ৳${amountNum} from your wallet.`, type:'warning', timestamp: firebase.database.ServerValue.TIMESTAMP, read:false });
          }).catch(err => showNotification('Error', err.message, 'error'));
        } else if (amount !== null) {
          showNotification('Error', 'Please enter a valid amount', 'error');
        }
      });
    });
  });
}

// Users: organizers
function loadOrganizers() {
  db.ref('users').orderByChild('role').equalTo('organizer').on('value', snap => {
    const organizers = snap.val() || {};
    const body = document.getElementById('organizers-body');
    body.innerHTML = '';
    Object.entries(organizers).forEach(([uid, org]) => {
      const tr = document.createElement('tr');
      const statusBadge = org.ban ? '<span class="badge badge-pill badge-banned">Banned</span>' : (org.verified ? '<span class="badge badge-pill badge-verified">Verified</span>' : '<span class="badge badge-pill" style="background: rgba(255,255,255,0.1);">Active</span>');
      tr.innerHTML = `
        <td>${org.name || '-'} ${org.verified ? '<i class="fas fa-check-circle blue-tick ms-1"></i>' : ''}</td>
        <td>${org.email || '-'}</td>
        <td><span class="badge badge-pill" style="background: rgba(255, 193, 7, 0.2); color:#ffc107;">${org.referralCount || 0} Referrals</span></td>
        <td>৳${org.wallet || 0}</td>
        <td>${statusBadge}</td>
        <td class="action-buttons">
          <button class="btn btn-sm btn-brand ban-btn" data-uid="${uid}" data-ban="${org.ban || false}">${org.ban ? '<i class="fas fa-unlock me-1"></i> Unban' : '<i class="fas fa-ban me-1"></i> Ban'}</button>
          <button class="btn btn-sm btn-accent verify-btn" data-uid="${uid}" data-verified="${org.verified || false}">${org.verified ? '<i class="fas fa-times me-1"></i> Unverify' : '<i class="fas fa-check me-1"></i> Verify'}</button>
          <button class="btn btn-sm btn-deduct ms-1 deduct-balance-btn" data-uid="${uid}"><i class="fas fa-minus me-1"></i> Deduct Balance</button>
        </td>
      `;
      body.appendChild(tr);
      tr.querySelector('.ban-btn').addEventListener('click', function() {
        const isBanned = this.getAttribute('data-ban') === 'true';
        db.ref(`users/${uid}/ban`).set(!isBanned).then(() => {
          showNotification(isBanned ? 'Organizer Unbanned' : 'Organizer Banned', `${org.name || 'Organizer'} has been ${isBanned ? 'unbanned' : 'banned'}`, isBanned ? 'success' : 'warning');
          logActivity(!isBanned ? 'ban_organizer' : 'unban_organizer', `${org.name || 'Organizer'} (${uid}) ${!isBanned ? 'banned' : 'unbanned'}`);
          if (!isBanned) {
            const nid = Date.now();
            db.ref(`userNotifications/${uid}/${nid}`).set({ title:'Account Status Update', message:'Your account has been banned by admin. Please contact support.', type:'important', timestamp: firebase.database.ServerValue.TIMESTAMP, read:false });
          }
        }).catch(err => showNotification('Error', err.message, 'error'));
      });
      tr.querySelector('.verify-btn').addEventListener('click', function() {
        const isVerified = this.getAttribute('data-verified') === 'true';
        db.ref(`users/${uid}/verified`).set(!isVerified).then(() => {
          showNotification(isVerified ? 'Organizer Unverified' : 'Organizer Verified', `${org.name || 'Organizer'} has been ${isVerified ? 'unverified' : 'verified'}`, 'success');
          logActivity(!isVerified ? 'verify_organizer' : 'unverify_organizer', `${org.name || 'Organizer'} (${uid}) ${!isVerified ? 'verified' : 'unverified'}`);
          const nid = Date.now();
          db.ref(`userNotifications/${uid}/${nid}`).set({ title:'Verification Status Update', message:`Your organizer account has been ${isVerified ? 'unverified' : 'verified'}.`, type:'info', timestamp: firebase.database.ServerValue.TIMESTAMP, read:false });
        }).catch(err => showNotification('Error', err.message, 'error'));
      });
      tr.querySelector('.deduct-balance-btn').addEventListener('click', function() {
        const amount = prompt(`Enter amount to deduct from ${org.name || 'organizer'}'s wallet:`);
        if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
          const amountNum = parseFloat(amount);
          db.ref(`users/${uid}/wallet`).transaction(c => {
            const current = c || 0;
            if (current < amountNum) {
              showNotification('Error', `Organizer only has ৳${current} in wallet`, 'error');
              return current;
            }
            return current - amountNum;
          }).then(() => {
            showNotification('Balance Deducted', `৳${amountNum} deducted from ${org.name || 'organizer'}`, 'success');
            logActivity('deduct_balance', `Deducted ৳${amountNum} from ${org.name || 'Organizer'} (${uid})`);
            const nid = Date.now();
            db.ref(`userNotifications/${uid}/${nid}`).set({ title:'Balance Deducted', message:`Admin deducted ৳${amountNum} from your wallet.`, type:'warning', timestamp: firebase.database.ServerValue.TIMESTAMP, read:false });
          }).catch(err => showNotification('Error', err.message, 'error'));
        } else if (amount !== null) {
          showNotification('Error', 'Please enter a valid amount', 'error');
        }
      });
    });
  });
}

// Deposits (players)
function loadBalanceRequests() {
  db.ref('paymentRequests').orderByChild('type').equalTo('deposit').on('value', snap => {
    const requests = snap.val() || {};
    const body = document.getElementById('balance-req-body');
    body.innerHTML = '';
    Object.entries(requests).forEach(([rid, req]) => {
      const user = usersCache[req.userId] || {};
      const statusBadge = req.status === 'pending' ? '<span class="badge badge-pill badge-pending">Pending</span>' :
                          req.status === 'approved' ? '<span class="badge badge-pill badge-approved">Approved</span>' :
                          '<span class="badge badge-pill badge-rejected">Rejected</span>';
      const d = new Date(req.timestamp);
      const dateStr = isNaN(d) ? '-' : d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${user.name || 'N/A'}</td>
        <td>${user.email || 'N/A'}</td>
        <td>৳${req.amount || 0}</td>
        <td>${req.number || '-'}</td>
        <td>${(req.method || '').toUpperCase()}</td>
        <td>${statusBadge}</td>
        <td>${dateStr}</td>
        <td class="action-buttons">
          ${req.status === 'pending' ? `
            <button class="btn btn-sm btn-success approve-btn me-1" data-rid="${rid}" data-uid="${req.userId}" data-amount="${req.amount}"><i class="fas fa-check me-1"></i> Approve</button>
            <button class="btn btn-sm btn-danger reject-btn" data-rid="${rid}" data-uid="${req.userId}" data-amount="${req.amount}"><i class="fas fa-times me-1"></i> Reject</button>
          ` : 'No actions'}
        </td>
      `;
      body.appendChild(tr);
      if (req.status === 'pending') {
        tr.querySelector('.approve-btn').addEventListener('click', async function() {
          const requestId = this.getAttribute('data-rid');
          const userId = this.getAttribute('data-uid');
          const amount = parseInt(this.getAttribute('data-amount'));
          try {
            await db.ref(`paymentRequests/${requestId}/status`).set('approved');
            await db.ref(`users/${userId}/wallet`).transaction(c => (c || 0) + amount);
            showNotification('Deposit Approved', `৳${amount} added to ${usersCache[userId]?.name || 'user'}`, 'success');
            logActivity('deposit_approved', `Approved ৳${amount} deposit for ${usersCache[userId]?.name || userId}`);
            const nid = Date.now();
            db.ref(`userNotifications/${userId}/${nid}`).set({ title:'Deposit Approved', message:`Your deposit of ৳${amount} has been approved.`, type:'success', timestamp: firebase.database.ServerValue.TIMESTAMP, read:false });
          } catch (e) { showNotification('Error', e.message, 'error'); }
        });
        tr.querySelector('.reject-btn').addEventListener('click', function() {
          const requestId = this.getAttribute('data-rid');
          const userId = this.getAttribute('data-uid');
          const amount = parseInt(this.getAttribute('data-amount'));
          db.ref(`paymentRequests/${requestId}/status`).set('rejected').then(() => {
            showNotification('Deposit Rejected', `Deposit request rejected`, 'warning');
            logActivity('deposit_rejected', `Rejected ৳${amount} deposit for ${usersCache[userId]?.name || userId}`);
            const nid = Date.now();
            db.ref(`userNotifications/${userId}/${nid}`).set({ title:'Deposit Rejected', message:`Your deposit of ৳${amount} has been rejected.`, type:'warning', timestamp: firebase.database.ServerValue.TIMESTAMP, read:false });
          }).catch(e => showNotification('Error', e.message, 'error'));
        });
      }
    });
  });
}

// Withdrawals (players + organizers)
function loadWithdrawRequests() {
  db.ref('paymentRequests').orderByChild('type').equalTo('withdraw').on('value', snap => {
    const requests = snap.val() || {};
    const body = document.getElementById('withdraw-req-body');
    body.innerHTML = '';
    Object.entries(requests).forEach(([rid, req]) => {
      const user = usersCache[req.userId] || {};
      const role = user.role || '-';
      const statusBadge = req.status === 'pending' ? '<span class="badge badge-pill badge-pending">Pending</span>' :
                          req.status === 'approved' ? '<span class="badge badge-pill badge-approved">Approved</span>' :
                          '<span class="badge badge-pill badge-rejected">Rejected</span>';
      const d = new Date(req.timestamp);
      const dateStr = isNaN(d) ? '-' : d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${user.name || 'N/A'}</td>
        <td>${user.email || 'N/A'}</td>
        <td><span class="badge ${role === 'organizer' ? 'bg-info' : 'bg-secondary'}">${role}</span></td>
        <td>৳${req.amount || 0}</td>
        <td>${req.number || '-'}</td>
        <td>${(req.method || '').toUpperCase()}</td>
        <td>${statusBadge}</td>
        <td>${dateStr}</td>
        <td class="action-buttons">
          ${req.status === 'pending' ? `
            <button class="btn btn-sm btn-success approve-btn me-1" data-rid="${rid}" data-uid="${req.userId}" data-amount="${req.amount}"><i class="fas fa-check me-1"></i> Approve</button>
            <button class="btn btn-sm btn-danger reject-btn" data-rid="${rid}" data-uid="${req.userId}" data-amount="${req.amount}"><i class="fas fa-times me-1"></i> Reject</button>
          ` : 'No actions'}
        </td>
      `;
      body.appendChild(tr);
      if (req.status === 'pending') {
        tr.querySelector('.approve-btn').addEventListener('click', async function() {
          const requestId = this.getAttribute('data-rid');
          const userId = this.getAttribute('data-uid');
          const amount = parseInt(this.getAttribute('data-amount')) || 0;
          try {
            await db.ref(`paymentRequests/${requestId}/status`).set('approved');
            await db.ref(`users/${userId}/wallet`).transaction(c => (c || 0) - amount);
            showNotification('Withdrawal Approved', `৳${amount} withdrawn from ${usersCache[userId]?.name || 'user'}`, 'success');
            logActivity('withdrawal_approved', `Approved ৳${amount} withdrawal for ${usersCache[userId]?.name || userId}`);
            const nid = Date.now();
            db.ref(`userNotifications/${userId}/${nid}`).set({ title:'Withdrawal Approved', message:`Your withdrawal of ৳${amount} has been approved.`, type:'success', timestamp: firebase.database.ServerValue.TIMESTAMP, read:false });
          } catch (e) { showNotification('Error', e.message, 'error'); }
        });
        tr.querySelector('.reject-btn').addEventListener('click', function() {
          const requestId = this.getAttribute('data-rid');
          const userId = this.getAttribute('data-uid');
          const amount = parseInt(this.getAttribute('data-amount')) || 0;
          db.ref(`paymentRequests/${requestId}/status`).set('rejected').then(() => {
            showNotification('Withdrawal Rejected', `Withdrawal request rejected`, 'warning');
            logActivity('withdrawal_rejected', `Rejected ৳${amount} withdrawal for ${usersCache[userId]?.name || userId}`);
            const nid = Date.now();
            db.ref(`userNotifications/${userId}/${nid}`).set({ title:'Withdrawal Rejected', message:`Your withdrawal request of ৳${amount} has been rejected.`, type:'warning', timestamp: firebase.database.ServerValue.TIMESTAMP, read:false });
          }).catch(e => showNotification('Error', e.message, 'error'));
        });
      }
    });
  });
}

// Tournaments
function loadTournaments() {
  db.ref('tournaments').on('value', snap => {
    const tournaments = snap.val() || {};
    const body = document.getElementById('tournaments-body');
    body.innerHTML = '';
    Object.entries(tournaments).forEach(([tid, t]) => {
      // Get organizer name from users cache
      const organizerName = t.organizer && usersCache[t.organizer] ? usersCache[t.organizer].name : (t.organizerName || 'N/A');
      
      const statusBadge = t.status === 'pending' ? '<span class="badge badge-pill badge-pending">Pending</span>' :
                          t.status === 'approved' ? '<span class="badge badge-pill badge-approved">Approved</span>' :
                          t.status === 'completed' ? '<span class="badge badge-pill" style="background: rgba(0, 123, 255, 0.2); color:#007bff;">Completed</span>' :
                          '<span class="badge badge-pill badge-rejected">Rejected</span>';
      const dt = new Date(t.date);
      const dateStr = (isNaN(dt) ? (t.date || '-') : dt.toLocaleDateString()) + ' ' + (t.time || '');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${t.name || '-'}</td>
        <td>${organizerName}</td>
        <td>৳${t.fee || 0}</td>
        <td>৳${t.prize || 'N/A'}</td>
        <td>${dateStr}</td>
        <td>${statusBadge}</td>
        <td class="action-buttons">
          <button class="btn btn-sm btn-brand edit-btn" data-tid="${tid}"><i class="fas fa-edit me-1"></i> Edit</button>
          <button class="btn btn-sm btn-danger delete-btn" data-tid="${tid}" data-name="${t.name}"><i class="fas fa-trash me-1"></i> Delete</button>
          ${t.status === 'pending' ? `
            <button class="btn btn-sm btn-success approve-btn me-1" data-tid="${tid}" data-organizer="${t.organizer}"><i class="fas fa-check me-1"></i> Approve</button>
            <button class="btn btn-sm btn-danger reject-btn" data-tid="${tid}" data-organizer="${t.organizer}"><i class="fas fa-times me-1"></i> Reject</button>
          ` : ''}
        </td>
      `;
      body.appendChild(tr);

      tr.querySelector('.edit-btn').addEventListener('click', function() {
        const id = this.getAttribute('data-tid');
        const data = tournaments[id];
        document.getElementById('edit-tournament-id').value = id;
        document.getElementById('edit-tournament-name').value = data.name || '';
        document.getElementById('edit-tournament-fee').value = data.fee || 0;
        document.getElementById('edit-tournament-prize').value = data.prize || '';
        document.getElementById('edit-tournament-status').value = data.status || 'pending';
        const d = new Date(data.date);
        document.getElementById('edit-tournament-date').value = !isNaN(d) ? d.toISOString().split('T')[0] : (data.date || '');
        document.getElementById('edit-tournament-time').value = data.time || '';
        document.getElementById('edit-tournament-desc').value = data.description || '';
        document.getElementById('edit-tournament-rules').value = data.rules || '';
        editTournamentModal.show();
      });

      tr.querySelector('.delete-btn').addEventListener('click', function() {
        const id = this.getAttribute('data-tid');
        const name = this.getAttribute('data-name');
        if (confirm(`Delete tournament "${name}"?`)) {
          db.ref(`tournaments/${id}`).remove().then(() => {
            showNotification('Tournament Deleted', `"${name}" has been deleted`, 'success');
            logActivity('tournament_deleted', `Deleted tournament "${name}" (${id})`);
          }).catch(e => showNotification('Error', e.message, 'error'));
        }
      });

      if (t.status === 'pending') {
        tr.querySelector('.approve-btn').addEventListener('click', function() {
          const id = this.getAttribute('data-tid');
          const orgId = this.getAttribute('data-organizer');
          db.ref(`tournaments/${id}/status`).set('approved').then(() => {
            showNotification('Tournament Approved', 'Tournament approved and published', 'success');
            logActivity('tournament_approved', `Approved tournament "${t.name}" (${id})`);
            const nid = Date.now();
            db.ref(`userNotifications/${orgId}/${nid}`).set({ title:'Tournament Approved', message:`Your tournament "${t.name}" is live.`, type:'success', timestamp: firebase.database.ServerValue.TIMESTAMP, read:false });
          }).catch(e => showNotification('Error', e.message, 'error'));
        });
        tr.querySelector('.reject-btn').addEventListener('click', function() {
          const id = this.getAttribute('data-tid');
          const orgId = this.getAttribute('data-organizer');
          db.ref(`tournaments/${id}/status`).set('rejected').then(() => {
            showNotification('Tournament Rejected', 'Tournament rejected', 'warning');
            logActivity('tournament_rejected', `Rejected tournament "${t.name}" (${id})`);
            const nid = Date.now();
            db.ref(`userNotifications/${orgId}/${nid}`).set({ title:'Tournament Rejected', message:`Your tournament "${t.name}" was rejected.`, type:'warning', timestamp: firebase.database.ServerValue.TIMESTAMP, read:false });
          }).catch(e => showNotification('Error', e.message, 'error'));
        });
      }
    });
  });
}

// Update tournament
btnUpdateTournament.addEventListener('click', function() {
  const id = document.getElementById('edit-tournament-id').value;
  const data = {
    name: document.getElementById('edit-tournament-name').value,
    fee: document.getElementById('edit-tournament-fee').value,
    prize: document.getElementById('edit-tournament-prize').value,
    status: document.getElementById('edit-tournament-status').value,
    date: document.getElementById('edit-tournament-date').value,
    time: document.getElementById('edit-tournament-time').value,
    description: document.getElementById('edit-tournament-desc').value,
    rules: document.getElementById('edit-tournament-rules').value
  };
  if (!data.name || !data.fee || !data.date) { showNotification('Error', 'Please fill all required fields', 'error'); return; }
  db.ref(`tournaments/${id}`).update(data).then(() => {
    showNotification('Tournament Updated', 'Tournament details updated', 'success');
    logActivity('tournament_updated', `Updated tournament "${data.name}" (${id})`);
    editTournamentModal.hide();
  }).catch(e => showNotification('Error', e.message, 'error'));
});

// Analytics (Charts)
function setupAnalytics() {
  db.ref('users').on('value', snap => {
    const users = snap.val() || {};
    const totalUsers = Object.keys(users).length;
    let players = 0, organizers = 0, others = 0, online = 0;
    const now = Date.now();
    Object.entries(users).forEach(([uid, u]) => {
      const role = u.role || 'other';
      if (role === 'player') players++;
      else if (role === 'organizer') organizers++;
      else others++;
      const isOnline = (u.online === true) || (u.lastActive && (now - u.lastActive) <= 5 * 60 * 1000);
      if (isOnline) online++;
    });
    renderAnalyticsCharts({ totalUsers, players, organizers, others, online });
  });
}

function renderAnalyticsCharts({ totalUsers, players, organizers, others, online }) {
  const countsCtx = document.getElementById('countsChart').getContext('2d');
  const rolesCtx = document.getElementById('rolesChart').getContext('2d');

  const countsData = {
    labels: ['Total Users', 'Players', 'Organizers', 'Online Users'],
    datasets: [{
      label: 'Counts',
      data: [totalUsers, players, organizers, online],
      backgroundColor: ['#6e00ff', '#00f0ff', '#ff00f7', '#28a745']
    }]
  };

  if (!countsChart) {
    countsChart = new Chart(countsCtx, {
      type: 'bar',
      data: countsData,
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#8a8aa8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
          y: { ticks: { color: '#8a8aa8' }, grid: { color: 'rgba(255,255,255,0.05)' }, beginAtZero: true }
        }
      }
    });
  } else {
    countsChart.data = countsData;
    countsChart.update();
  }

  const rolesData = {
    labels: ['Players', 'Organizers', 'Others'],
    datasets: [{
      label: 'Roles',
      data: [players, organizers, others],
      backgroundColor: ['#00f0ff', '#ff00f7', '#6e00ff']
    }]
  };

  if (!rolesChart) {
    rolesChart = new Chart(rolesCtx, {
      type: 'doughnut',
      data: rolesData,
      options: {
        responsive: true,
        plugins: {
          legend: { labels: { color: '#e0e0ff' } }
        }
      }
    });
  } else {
    rolesChart.data = rolesData;
    rolesChart.update();
  }
}

// Admin Activity UI
function loadAdminActivity() {
  db.ref('adminActivity').orderByChild('timestamp').limitToLast(100).on('value', snap => {
    const items = snap.val() || {};
    const arr = Object.values(items).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
    const body = document.getElementById('activity-body');
    body.innerHTML = '';
    arr.forEach(it => {
      const d = new Date(it.timestamp);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${isNaN(d) ? '-' : d.toLocaleString()}</td>
        <td>${it.action || '-'}</td>
        <td>${it.details || '-'}</td>
        <td>${it.admin || 'Admin'}</td>
      `;
      body.appendChild(tr);
    });
  });
}

// Init
document.addEventListener('DOMContentLoaded', () => {
  if (isAuthenticated) {
    loginModal.style.display = 'none';
    adminContent.style.display = 'block';
    loadAllData();
    setupAnalytics();
    loadAdminActivity();
  }
});
</script>
</body>
</html>
